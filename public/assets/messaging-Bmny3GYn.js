import{r as n,i as ve,j as s,s as we,k as ke,e as Ae,T as o,O as m,P as Te,t as c,x as R,w as f,R as Pe,I as Ie,Q,L as Ee}from"./index-CguHGk5K.js";import{C as Ye}from"./config-global-C1bjA4IF.js";import{D as ze}from"./content-DrNzMyEl.js";import{k as Ue,l as We,u as Le,C as L,S as ie,L as Ne,A as Oe,D as le,T as Fe,a as Be,b as _e,c as q,d as D,e as Je,f as $e,g as Ge,h as He,i as Qe,j as qe,m as Ke,n as Ve,o as Xe}from"./AdapterDayjs-DCEGGqcx.js";import{a as v}from"./config-BgS2nir-.js";import{T as K}from"./TextField-BHvFdFV8.js";import{B as Ze}from"./Breadcrumbs-BfR6RiXn.js";import"./index-Chjiymov.js";const es=x=>{const{classes:l}=x;return Ae({root:["root"]},We,l)},ss=we(o,{name:"MuiDialogTitle",slot:"Root",overridesResolver:(x,l)=>l.root})({padding:"16px 24px",flex:"0 0 auto"}),ts=n.forwardRef(function(l,i){const w=ve({props:l,name:"MuiDialogTitle"}),{className:M,id:S,...p}=w,k=w,j=es(k),{titleId:A=S}=n.useContext(Ue);return s.jsx(ss,{component:"h2",className:ke(j.root,M),ownerState:k,ref:i,variant:"h6",id:S??A,...p})});class as{async getMessages(l){try{return(await v.get("/messages",{params:l})).data.data||[]}catch(i){return console.error("Error fetching messages data:",i),[]}}async markAsRead(l){try{await v.put(`/messages/${l}/read`)}catch(i){throw console.error("Error marking message as read:",i),i}}async markAllAsRead(){try{await v.put("/messages/read-all")}catch(l){throw console.error("Error marking all as read:",l),l}}async checkUserExists(l){try{return((await v.get("/messages",{params:{user_id:l}})).data.data||[]).length>0}catch(i){return console.error("Error checking user:",i),!1}}}const N=new as;function rs(){const[x,l]=n.useState("desc"),[i,w]=n.useState("date"),[M,S]=n.useState(0),[p,k]=n.useState(5),[j,A]=n.useState(""),[h,T]=n.useState(null),[u,P]=n.useState(null),[I,E]=n.useState(""),[V,O]=n.useState(m().year()),[ce,X]=n.useState(!1),[g,Z]=n.useState(null),[y,C]=n.useState([]),[F,Y]=n.useState(!0),[b,ee]=n.useState(null),[B,z]=n.useState(null),[d,se]=n.useState(null),[te,de]=n.useState(!0),he=Le("(max-width:600px)"),_=m().format("MMMM"),J=m().year();n.useEffect(()=>{(async()=>{try{const t=localStorage.getItem("user");if(t){se(JSON.parse(t));return}const a=await v.get("/auth/user");se(a.data.data)}catch(t){console.error("Failed to get current user:",t)}})()},[]),n.useEffect(()=>{const e=m();T(e.startOf("day")),P(e.endOf("day")),E(_),O(J)},[_,J]);const ue=async()=>{if(d!=null&&d.user_id)try{Y(!0);const e=await N.checkUserExists(d.user_id);ee(e)}catch(e){console.error("Error checking user:",e),ee(!1)}finally{de(!1),Y(!1)}};n.useEffect(()=>{d&&ue()},[d]);const xe=async()=>{if(!(!(d!=null&&d.user_id)||!h||!u)){Y(!0);try{const e={startDate:h.format("YYYY-MM-DD"),endDate:u.format("YYYY-MM-DD"),search:j||void 0,user_id:d.user_id},a=(await N.getMessages(e)).map(r=>({id:r.id,user_id:r.user_id,date:r.date,subject:r.subject,message:r.message,status:r.status,isRead:r.status==="read"}));C(a)}catch(e){console.error("Error fetching messages:",e)}finally{Y(!1)}}};n.useEffect(()=>{b&&h&&u&&d&&xe()},[h,u,j,b,d]);const me=async e=>{z(e);try{C(t=>t.map(a=>a.id===e?{...a,isRead:!0,status:"read"}:a)),await N.markAsRead(e)}catch{C(a=>a.map(r=>r.id===e?{...r,isRead:!1,status:"unread"}:r)),alert("Failed to mark message as read. Please try again.")}finally{z(null)}},ge=async()=>{const e=y.filter(t=>!t.isRead);if(e.length!==0){z(-1);try{C(t=>t.map(a=>({...a,isRead:!0,status:"read"}))),await N.markAllAsRead()}catch{C(a=>a.map(r=>e.find(De=>De.id===r.id)?{...r,isRead:!1,status:"unread"}:r)),alert("Failed to mark all messages as read. Please try again.")}finally{z(null)}}},ae=async e=>{Z(e),X(!0),e.isRead||await me(e.id)},re=()=>{X(!1),Z(null)},U=n.useMemo(()=>y.filter(e=>{if(!Object.values(e).some(r=>r.toString().toLowerCase().includes(j.toLowerCase())))return!1;const a=m(e.date);return!(h&&a.isBefore(h,"day")||u&&a.isAfter(u,"day"))}),[y,j,h,u]),$=n.useMemo(()=>[...U].sort((e,t)=>{let a=e[i],r=t[i];return i==="date"?(a=new Date(e.date).getTime(),r=new Date(t.date).getTime()):i==="isRead"?(a=e.isRead?1:0,r=t.isRead?1:0):(a=(a==null?void 0:a.toString().toLowerCase())||"",r=(r==null?void 0:r.toString().toLowerCase())||""),typeof a=="number"&&typeof r=="number"?x==="asc"?a-r:r-a:x==="asc"?a.toString().localeCompare(r.toString()):r.toString().localeCompare(a.toString())}),[U,x,i]),W=n.useMemo(()=>$.slice(M*p,M*p+p),[$,M,p]);n.useMemo(()=>y.filter(e=>!e.isRead).length,[y]);const G=n.useMemo(()=>U.filter(e=>!e.isRead).length,[U]),fe=[{id:"date",label:"DATE"},{id:"subject",label:"SUBJECT"},{id:"isRead",label:"STATUS"}],pe=n.useMemo(()=>["January","February","March","April","May","June","July","August","September","October","November","December"],[]),je=n.useMemo(()=>{const e=m().year();return[e-1,e,e+1]},[]),ne=(e,t=V)=>{const a=m(`${t}-${e}-01`,"YYYY-MMMM-DD"),r=a.endOf("month");T(a),P(r)},ye=e=>{E(e),ne(e)},be=e=>{O(e),I&&I!=="Custom"&&ne(I,e)},oe=(e,t)=>{if(!t)return;const a=m();t.isAfter(a,"day")&&(t=a),e==="start"?(u&&t.isAfter(u,"day")&&(t=u),T(t)):(h&&t.isBefore(h,"day")&&(t=h),P(t)),E("Custom")},Me=()=>{A("");const e=m();T(e.startOf("day")),P(e.endOf("day")),E(_),O(J)},Se=(e,t)=>{l(i===t&&x==="asc"?"desc":"asc"),w(t)},Ce=(e,t)=>S(t),Re=e=>{k(parseInt(e.target.value,10)),S(0)},H=e=>m(e).format("MMM DD, YYYY");return s.jsxs(Te,{sx:{width:"100%",overflow:"hidden",boxShadow:3,borderRadius:2},children:[s.jsxs(c,{sx:{p:2},children:[s.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[s.jsx(o,{variant:"h6",children:"Messages"}),s.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:2},children:[b===!1&&s.jsx(L,{label:"No messages found",color:"error",size:"small",variant:"outlined"}),b===!0&&G>0&&s.jsx(L,{label:`${G} unread`,color:"primary",size:"small",variant:"outlined"}),b===!0&&G>0&&s.jsx(R,{variant:"outlined",size:"small",onClick:ge,disabled:B===-1,startIcon:B===-1?s.jsx(f,{icon:"solar:restart-bold",width:16,height:16}):s.jsx(f,{icon:"solar:eye-bold",width:16,height:16}),children:B===-1?"Marking...":"Mark all as read"})]})]}),(F||te)&&s.jsxs(c,{sx:{width:"100%",mb:2},children:[s.jsx(Pe,{}),s.jsx(c,{sx:{p:2,textAlign:"center"},children:s.jsx(o,{variant:"body2",color:"text.secondary",children:te?"Checking user...":"Loading messages..."})})]}),b===!1&&!F&&s.jsxs(c,{sx:{p:3,textAlign:"center"},children:[s.jsx(o,{color:"error",variant:"h6",children:"No messages found"}),s.jsx(o,{color:"text.secondary",sx:{mt:1},children:"No messages available for this user."})]}),b===!0&&!F&&s.jsxs(s.Fragment,{children:[s.jsxs(ie,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},sx:{mb:2},children:[s.jsx(K,{variant:"outlined",size:"small",placeholder:"Search messages...",value:j,onChange:e=>A(e.target.value),fullWidth:!0,sx:{"& .MuiOutlinedInput-root":{height:40},width:{sm:220}},InputProps:{endAdornment:s.jsx(Ie,{position:"end",children:s.jsx(f,{icon:"eva:search-fill",width:18,height:18})})}}),s.jsx(K,{select:!0,size:"small",value:V,onChange:e=>be(Number(e.target.value)),sx:{width:{sm:120}},children:je.map(e=>s.jsx(Q,{value:e,children:e},e))}),s.jsxs(K,{select:!0,size:"small",value:I,onChange:e=>ye(e.target.value),sx:{width:{sm:160}},children:[pe.map(e=>s.jsx(Q,{value:e,children:e},e)),s.jsx(Q,{value:"Custom",children:"Custom"})]}),s.jsx(Ne,{dateAdapter:Oe,children:s.jsxs(ie,{direction:{xs:"column",sm:"row"},spacing:1,sx:{width:"100%"},children:[s.jsx(le,{label:"From",value:h,onChange:e=>oe("start",e),slotProps:{textField:{size:"small",fullWidth:!0,sx:{width:{sm:160}}}}}),s.jsx(le,{label:"To",value:u,onChange:e=>oe("end",e),slotProps:{textField:{size:"small",fullWidth:!0,sx:{width:{sm:160}}}}})]})}),s.jsx(R,{variant:"outlined",size:"small",onClick:Me,sx:{height:40,width:{xs:"100%",sm:"auto"},minWidth:80},children:"Reset"})]}),he?s.jsx(c,{sx:{px:2,pb:2},children:W.length>0?W.map(e=>s.jsxs(Ge,{onClick:()=>ae(e),sx:{mb:1.5,borderRadius:2,overflow:"hidden",boxShadow:"0 2px 8px rgba(0,0,0,0.08)","&:before":{display:"none"},border:e.isRead?"1px solid":"2px solid",borderColor:e.isRead?"divider":"error.main",backgroundColor:e.isRead?"background.paper":"rgba(255, 0, 0, 0.08)"},children:[s.jsx(He,{expandIcon:s.jsx(f,{icon:"eva:arrow-ios-downward-fill",width:20,height:20,color:e.isRead?"inherit":"error.main"}),sx:{bgcolor:e.isRead?"primary.main":"error.light",color:"#fff","& .MuiAccordionSummary-content":{alignItems:"center"}},children:s.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.jsx(o,{fontWeight:600,children:H(e.date)}),!e.isRead&&s.jsx(L,{label:"New",color:"error",size:"small",sx:{height:20,fontSize:"0.7rem",fontWeight:"bold"}})]})}),s.jsxs(Qe,{sx:{display:"flex",flexDirection:"column",gap:1.5,py:2,px:2,bgcolor:"background.paper"},children:[s.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[s.jsx(o,{color:"primary.dark",fontWeight:600,children:"Subject"}),s.jsx(o,{color:"text.primary",children:e.subject})]}),e.message&&s.jsxs(c,{sx:{display:"flex",flexDirection:"column",gap:1},children:[s.jsx(o,{color:"primary.dark",fontWeight:600,children:"Message"}),s.jsx(o,{color:"text.secondary",sx:{whiteSpace:"pre-wrap"},children:e.message})]}),s.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pt:1,borderTop:"1px solid",borderColor:"divider"},children:[s.jsx(o,{color:"text.secondary",fontWeight:600,children:"Status"}),s.jsx(R,{variant:"outlined",size:"small",color:e.isRead?"success":"error",startIcon:s.jsx(f,{icon:e.isRead?"solar:eye-bold":"solar:eye-closed-bold"}),sx:{minWidth:"100px",pointerEvents:"none"},children:e.isRead?"Read":"Unread"})]})]})]},e.id)):s.jsx(o,{color:"text.secondary",align:"center",children:y.length===0?"No messages found for selected period":"No messages match your search"})}):s.jsx(Fe,{children:s.jsxs(Be,{children:[s.jsx(_e,{children:s.jsx(q,{children:fe.map(e=>s.jsx(D,{sx:{bgcolor:"primary.main",color:"#fff",fontWeight:600},children:s.jsx(Je,{active:i===e.id,direction:i===e.id?x:"asc",onClick:t=>Se(t,e.id),sx:{color:"rgba(255,255,255,0.75)","&.Mui-active, &:hover":{color:"#fff !important"},"& .MuiTableSortLabel-icon":{color:"#fff !important"}},children:e.label})},e.id))})}),s.jsx($e,{children:W.length>0?W.map(e=>s.jsxs(q,{hover:!0,onClick:()=>ae(e),sx:{cursor:"pointer",backgroundColor:e.isRead?"transparent":"rgba(255, 0, 0, 0.08)",transition:"background-color 0.3s","&:hover":{backgroundColor:e.isRead?"rgba(0, 0, 0, 0.04)":"rgba(255, 0, 0, 0.12)"}},children:[s.jsx(D,{children:s.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[!e.isRead&&s.jsx(c,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:"error.main"}}),H(e.date)]})}),s.jsx(D,{children:e.subject}),s.jsx(D,{children:s.jsx(R,{variant:"outlined",size:"small",color:e.isRead?"success":"error",startIcon:s.jsx(f,{icon:e.isRead?"solar:eye-bold":"solar:eye-closed-bold"}),sx:{minWidth:"100px",pointerEvents:"none"},children:e.isRead?"Read":"Unread"})})]},e.id)):s.jsx(q,{children:s.jsx(D,{colSpan:3,align:"center",children:s.jsx(o,{color:"text.secondary",children:y.length===0?"No messages found for selected period":"No messages match your search"})})})})]})}),s.jsx(qe,{rowsPerPageOptions:[5,10,25],component:"div",count:$.length,rowsPerPage:p,page:M,onPageChange:Ce,onRowsPerPageChange:Re})]})]}),s.jsxs(Ke,{open:ce,onClose:re,maxWidth:"sm",fullWidth:!0,children:[s.jsx(ts,{children:"Message Details"}),s.jsx(Ve,{children:g&&s.jsxs(c,{sx:{py:2},children:[s.jsx(o,{variant:"subtitle2",color:"text.secondary",children:"User ID"}),s.jsx(o,{variant:"body1",sx:{mb:2},children:g.user_id}),s.jsx(o,{variant:"subtitle2",color:"text.secondary",children:"Date"}),s.jsx(o,{variant:"body1",sx:{mb:2},children:H(g.date)}),s.jsx(o,{variant:"subtitle2",color:"text.secondary",children:"Subject"}),s.jsx(o,{variant:"body1",sx:{mb:2},children:g.subject}),g.message&&s.jsxs(s.Fragment,{children:[s.jsx(o,{variant:"subtitle2",color:"text.secondary",children:"Message"}),s.jsx(o,{variant:"body1",sx:{mb:2,whiteSpace:"pre-wrap"},children:g.message})]}),s.jsx(L,{label:g.isRead?"Read":"Unread",color:g.isRead?"success":"error",size:"small"})]})}),s.jsx(Xe,{children:s.jsx(R,{onClick:re,children:"Close"})})]})]})}function ns(){return s.jsxs(ze,{children:[s.jsxs(c,{sx:{mb:5},children:[s.jsxs(Ze,{"aria-label":"breadcrumb",separator:s.jsx(f,{icon:"eva:chevron-right-fill",width:14,sx:{color:"text.secondary",mx:.5}}),sx:{fontSize:13,mb:3,"& a":{color:"text.secondary"}},children:[s.jsxs(Ee,{underline:"hover",href:"/",sx:{display:"flex",alignItems:"center",fontWeight:500},children:[s.jsx(f,{icon:"eva:home-outline",width:16,sx:{mr:.5}}),"Dashboard"]}),s.jsx(o,{color:"text.primary",sx:{fontWeight:600},children:"Messages"})]}),s.jsx(c,{sx:{display:"flex",alignItems:"center"},children:s.jsx(o,{variant:"h5",sx:{flexGrow:1},children:"Messages & Announcements"})})]}),s.jsx(rs,{})]})}function gs(){return s.jsxs(s.Fragment,{children:[s.jsx("title",{children:`Messaging - ${Ye.appName}`}),s.jsx(ns,{})]})}export{gs as default};
