import{r as n,O as d,j as t,P as pe,t as c,T as o,I as ge,w as j,Q as W,x as z,R as je,L as ye}from"./index-CguHGk5K.js";import{C as be}from"./config-global-C1bjA4IF.js";import{D as Me}from"./content-DrNzMyEl.js";import{u as ke,C as v,S as X,L as Ae,A as Ce,D as Z,T as De,a as Re,b as _e,c as N,d as f,e as Se,f as ve,g as Ie,h as Ye,i as we,j as Te}from"./AdapterDayjs-DCEGGqcx.js";import{a as M}from"./config-BgS2nir-.js";import{T as L}from"./TextField-BHvFdFV8.js";import{B as Ee}from"./Breadcrumbs-BfR6RiXn.js";import"./index-Chjiymov.js";class Pe{async getAttendance(h){try{return(await M.get("/attendance",{params:h})).data.data||[]}catch(l){return console.error("Error fetching attendance data:",l),[]}}async markAsRead(h){try{await M.patch(`/attendance/${h}/read`)}catch(l){console.error("Error marking record as read:",l)}}async markAllAsRead(h){try{await M.patch("/attendance/read-all",{user_id:h})}catch(l){console.error("Error marking all as read:",l)}}async checkUserExists(h){try{return((await M.get("/attendance",{params:{user_id:h}})).data.data||[]).length>0}catch(l){return console.error("Error checking user:",l),!1}}async getCurrentUser(){try{const h=localStorage.getItem("user");return h?JSON.parse(h):localStorage.getItem("token")&&(await M.get("/auth/user")).data.data||null}catch(h){return console.error("Error getting current user:",h),null}}}const k=new Pe;function Oe(){const[g,h]=n.useState("desc"),[l,F]=n.useState("date"),[A,B]=n.useState(0),[y,V]=n.useState(5),[b,K]=n.useState(""),[x,I]=n.useState(null),[m,Y]=n.useState(null),[C,D]=n.useState(""),[$,w]=n.useState(d().year()),[R,T]=n.useState([]),[U,H]=n.useState(!1),[p,J]=n.useState(null),[a,ee]=n.useState(null),te=ke("(max-width:600px)");d().format("MMMM");const G=e=>{if(!e)return"-";if(e.includes("AM")||e.includes("PM"))return e;try{const[s,i]=e.split(":"),r=parseInt(s,10),u=r>=12?"PM":"AM";return`${r%12||12}:${i} ${u}`}catch{return e}},se=e=>d(e).format("MMM DD, YYYY");n.useEffect(()=>{const e=d().startOf("month"),s=d().endOf("month");I(e),Y(s),D(d().format("MMMM")),w(d().year())},[]),n.useEffect(()=>{re()},[]),n.useEffect(()=>{a!=null&&a.user_id&&ae()},[a]),n.useEffect(()=>{p&&x&&m&&(a!=null&&a.user_id)&&ne()},[x,m,b,p,a]);const re=async()=>{try{const e=await k.getCurrentUser();ee(e)}catch(e){console.error("Error getting current user:",e)}},ae=async()=>{if(a!=null&&a.user_id)try{const e=await k.checkUserExists(a.user_id);J(e)}catch(e){console.error("Error checking user:",e),J(!1)}},ne=async()=>{if(!(!x||!m||!(a!=null&&a.user_id))){H(!0);try{const e={startDate:x.format("YYYY-MM-DD"),endDate:m.format("YYYY-MM-DD"),search:b||void 0,user_id:a.user_id};console.log("Fetching attendance with filters:",e);const i=(await k.getAttendance(e)).map(r=>({id:r.id,user_id:r.user_id,date:se(r.date),time_in:G(r.time_in),kiosk_terminal_in:r.kiosk_terminal_in||"System Kiosk",time_out:G(r.time_out),kiosk_terminal_out:r.kiosk_terminal_out||"System Kiosk",status:r.status,isRead:r.status==="read"}));T(i)}catch(e){console.error("Error fetching attendance data:",e)}finally{H(!1)}}},oe=n.useMemo(()=>["January","February","March","April","May","June","July","August","September","October","November","December"],[]),ie=n.useMemo(()=>{const e=d().year();return Array.from({length:5},(s,i)=>e-2+i)},[]),E=(e,s=$)=>{const i=d(`${s}-${e}-01`,"YYYY-MMMM-DD"),r=i.endOf("month");I(i),Y(r)},le=e=>{D(e),E(e)},ce=e=>{w(e),C&&C!=="Custom"&&E(C,e)},Q=async e=>{T(s=>s.map(i=>i.id===e?{...i,isRead:!0,status:"read"}:i)),await k.markAsRead(e)},de=async()=>{a!=null&&a.user_id&&(T(e=>e.map(s=>({...s,isRead:!0,status:"read"}))),await k.markAllAsRead(a.user_id))},he=(e,s)=>{h(l===s&&g==="asc"?"desc":"asc"),F(s)},ue=(e,s)=>{B(s)},xe=e=>{V(parseInt(e.target.value,10)),B(0)},q=(e,s)=>{const i=d();s&&(s.isAfter(i,"day")&&(s=i),e==="start"?(m&&s.isAfter(m,"day")&&(s=m),I(s)):(x&&s.isBefore(x,"day")&&(s=x),Y(s)),D("Custom"))},me=()=>{K("");const e=d().format("MMMM"),s=d().year();D(e),w(s),E(e,s)},_=n.useMemo(()=>R.filter(e=>Object.values(e).some(s=>s.toString().toLowerCase().includes(b.toLowerCase()))&&(!x||!d(e.date,"MMM DD, YYYY").isBefore(x,"day"))&&(!m||!d(e.date,"MMM DD, YYYY").isAfter(m,"day"))),[R,b,x,m]),P=n.useMemo(()=>[..._].sort((s,i)=>{let r=s[l],u=i[l];return l==="date"?(r=d(s.date,"MMM DD, YYYY").valueOf(),u=d(i.date,"MMM DD, YYYY").valueOf()):l==="isRead"?(r=s.isRead?1:0,u=i.isRead?1:0):(r=(r==null?void 0:r.toString().toLowerCase())||"",u=(u==null?void 0:u.toString().toLowerCase())||""),typeof r=="number"&&typeof u=="number"?g==="asc"?r-u:u-r:g==="asc"?r.toString().localeCompare(u.toString()):u.toString().localeCompare(r.toString())}),[_,g,l]),S=n.useMemo(()=>P.slice(A*y,A*y+y),[P,A,y]),O=n.useMemo(()=>_.filter(e=>!e.isRead).length,[_]),fe=[{id:"date",label:"DATE"},{id:"user_id",label:"USER ID"},{id:"time_in",label:"TIME IN"},{id:"kiosk_terminal_in",label:"KIOSK TERMINAL (IN)"},{id:"time_out",label:"TIME OUT"},{id:"kiosk_terminal_out",label:"KIOSK TERMINAL (OUT)"},{id:"isRead",label:"STATUS"}];return t.jsxs(pe,{sx:{width:"100%",overflow:"hidden",boxShadow:3,borderRadius:2},children:[t.jsxs(c,{sx:{p:2,display:"flex",flexDirection:"column",gap:1.5},children:[t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",flexWrap:"wrap",gap:2},children:[t.jsx(o,{variant:"h6",children:"Attendance Records"}),t.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:2},children:[!a&&t.jsx(v,{label:"Please log in",color:"warning",size:"small",variant:"outlined"}),p===!1&&a&&t.jsx(v,{label:"No attendance records",color:"error",size:"small",variant:"outlined"}),p===!0&&O>0&&t.jsx(v,{label:`${O} unread`,color:"primary",size:"small",variant:"outlined"}),p===!0&&O>0&&t.jsx(o,{component:"button",onClick:de,sx:{cursor:"pointer",color:"primary.main",fontWeight:500,border:"none",background:"transparent",fontSize:"0.875rem","&:hover":{textDecoration:"underline"}},children:"Mark all as read"})]})]}),a&&p===!0&&t.jsxs(X,{direction:{xs:"column",sm:"row"},spacing:2,alignItems:{xs:"stretch",sm:"center"},sx:{width:"100%"},children:[t.jsx(L,{variant:"outlined",size:"small",placeholder:"Search records...",value:b,onChange:e=>K(e.target.value),fullWidth:!0,sx:{"& .MuiOutlinedInput-root":{height:40},width:{sm:220}},InputProps:{endAdornment:t.jsx(ge,{position:"end",children:t.jsx(j,{icon:"eva:search-fill",width:18,height:18})})}}),t.jsx(L,{select:!0,size:"small",value:$,onChange:e=>ce(Number(e.target.value)),sx:{width:{sm:120}},children:ie.map(e=>t.jsx(W,{value:e,children:e},e))}),t.jsxs(L,{select:!0,size:"small",value:C,onChange:e=>le(e.target.value),fullWidth:!0,sx:{width:{sm:160}},children:[oe.map(e=>t.jsx(W,{value:e,children:e},e)),t.jsx(W,{value:"Custom",children:"Custom"})]}),t.jsx(Ae,{dateAdapter:Ce,children:t.jsxs(X,{direction:{xs:"column",sm:"row"},spacing:1,sx:{width:"100%"},children:[t.jsx(Z,{label:"From",value:x,onChange:e=>q("start",e),slotProps:{textField:{size:"small",fullWidth:!0,sx:{width:{sm:160}}}}}),t.jsx(Z,{label:"To",value:m,onChange:e=>q("end",e),slotProps:{textField:{size:"small",fullWidth:!0,sx:{width:{sm:160}}}}})]})}),t.jsx(z,{variant:"outlined",size:"small",onClick:me,sx:{height:40,width:{xs:"100%",sm:"auto"},minWidth:80},children:"Reset"})]})]}),a&&p===!1&&t.jsxs(c,{sx:{p:3,textAlign:"center"},children:[t.jsx(o,{color:"error.main",variant:"h6",children:"No attendance records found"}),t.jsx(o,{color:"error",sx:{mt:1},children:"Attendance records will be created automatically when you log in."})]}),U&&t.jsxs(c,{sx:{width:"100%"},children:[t.jsx(je,{}),t.jsx(c,{sx:{p:2,textAlign:"center"},children:t.jsx(o,{variant:"body2",color:"text.secondary",children:"Loading attendance data..."})})]}),!U&&a&&p===!0&&t.jsxs(t.Fragment,{children:[te?t.jsx(c,{sx:{px:2,pb:2},children:S.length>0?S.map(e=>t.jsxs(Ie,{onClick:()=>Q(e.id),sx:{mb:1.5,borderRadius:2,overflow:"hidden",boxShadow:"0 2px 8px rgba(0,0,0,0.08)","&:before":{display:"none"},border:e.isRead?"1px solid":"2px solid",borderColor:e.isRead?"divider":"error.main",backgroundColor:e.isRead?"background.paper":"rgba(255, 0, 0, 0.08)"},children:[t.jsx(Ye,{expandIcon:t.jsx(j,{icon:"eva:arrow-ios-downward-fill",width:20,height:20,color:e.isRead?"inherit":"error.main"}),sx:{bgcolor:e.isRead?"primary.main":"error.light",color:"#fff","& .MuiAccordionSummary-content":{alignItems:"center"}},children:t.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(o,{fontWeight:600,children:e.date}),!e.isRead&&t.jsx(v,{label:"New",color:"error",size:"small",sx:{height:20,fontSize:"0.7rem",fontWeight:"bold"}})]})}),t.jsxs(we,{sx:{display:"flex",flexDirection:"column",gap:1.5,py:2,px:2,bgcolor:"background.paper"},children:[t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(o,{color:"primary.dark",fontWeight:600,children:"User ID"}),t.jsx(o,{color:"text.primary",children:e.user_id})]}),t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(o,{color:"primary.dark",fontWeight:600,children:"Time In"}),t.jsx(o,{color:"text.primary",children:e.time_in})]}),t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(o,{color:"primary.dark",fontWeight:600,children:"Kiosk (In)"}),t.jsx(o,{color:"text.secondary",children:e.kiosk_terminal_in})]}),t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(o,{color:"error.main",fontWeight:600,children:"Time Out"}),t.jsx(o,{color:"text.primary",children:e.time_out})]}),t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[t.jsx(o,{color:"error.main",fontWeight:600,children:"Kiosk (Out)"}),t.jsx(o,{color:"text.secondary",children:e.kiosk_terminal_out})]}),t.jsxs(c,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",pt:1,borderTop:"1px solid",borderColor:"divider"},children:[t.jsx(o,{color:"text.secondary",fontWeight:600,children:"Status"}),t.jsx(z,{variant:"outlined",size:"small",color:e.isRead?"success":"error",startIcon:t.jsx(j,{icon:e.isRead?"solar:eye-bold":"solar:eye-closed-bold"}),sx:{minWidth:"100px",pointerEvents:"none"},children:e.isRead?"Read":"Unread"})]})]})]},e.id)):t.jsx(o,{color:"text.secondary",align:"center",children:R.length===0?"No attendance records found for selected period":"No records match your search"})}):t.jsx(De,{children:t.jsxs(Re,{children:[t.jsx(_e,{children:t.jsx(N,{children:fe.map(e=>t.jsx(f,{sx:{bgcolor:"primary.main",color:"#fff",fontWeight:600},children:t.jsx(Se,{active:l===e.id,direction:l===e.id?g:"asc",onClick:s=>he(s,e.id),sx:{color:"rgba(255,255,255,0.75)","&.Mui-active, &:hover":{color:"#fff !important"},"& .MuiTableSortLabel-icon":{color:"#fff !important"}},children:e.label})},e.id))})}),t.jsx(ve,{children:S.length>0?S.map(e=>t.jsxs(N,{hover:!0,onClick:()=>Q(e.id),sx:{cursor:"pointer",backgroundColor:e.isRead?"transparent":"rgba(255, 0, 0, 0.08)",transition:"background-color 0.3s","&:hover":{backgroundColor:e.isRead?"rgba(0, 0, 0, 0.04)":"rgba(255, 0, 0, 0.12)"}},children:[t.jsx(f,{children:t.jsxs(c,{sx:{display:"flex",alignItems:"center",gap:1},children:[!e.isRead&&t.jsx(c,{sx:{width:8,height:8,borderRadius:"50%",bgcolor:"error.main"}}),e.date]})}),t.jsx(f,{children:e.user_id}),t.jsx(f,{children:e.time_in}),t.jsx(f,{children:e.kiosk_terminal_in}),t.jsx(f,{children:e.time_out}),t.jsx(f,{children:e.kiosk_terminal_out}),t.jsx(f,{children:t.jsx(z,{variant:"outlined",size:"small",color:e.isRead?"success":"error",startIcon:t.jsx(j,{icon:e.isRead?"solar:eye-bold":"solar:eye-closed-bold"}),sx:{minWidth:"100px",pointerEvents:"none"},children:e.isRead?"Read":"Unread"})})]},e.id)):t.jsx(N,{children:t.jsx(f,{colSpan:7,align:"center",children:t.jsx(o,{color:"text.secondary",children:R.length===0?"No attendance records found for selected period":"No records match your search"})})})})]})}),t.jsx(Te,{rowsPerPageOptions:[5,10,25],component:"div",count:P.length,rowsPerPage:y,page:A,onPageChange:ue,onRowsPerPageChange:xe})]})]})}function We(){return t.jsxs(Me,{children:[t.jsxs(c,{sx:{mb:5},children:[t.jsxs(Ee,{"aria-label":"breadcrumb",separator:t.jsx(j,{icon:"eva:chevron-right-fill",width:14,sx:{color:"text.secondary",mx:.5}}),sx:{fontSize:13,mb:3,"& a":{color:"text.secondary"}},children:[t.jsxs(ye,{underline:"hover",href:"/",sx:{display:"flex",alignItems:"center",fontWeight:500},children:[t.jsx(j,{icon:"eva:home-outline",width:16,sx:{mr:.5}}),"Dashboard"]}),t.jsx(o,{color:"text.primary",sx:{fontWeight:600},children:"Attendance"})]}),t.jsx(c,{sx:{display:"flex",alignItems:"center"},children:t.jsx(o,{variant:"h5",sx:{flexGrow:1},children:"Attendance"})})]}),t.jsx(Oe,{})]})}function Je(){return t.jsxs(t.Fragment,{children:[t.jsx("title",{children:`Attendance - ${be.appName}`}),t.jsx(We,{})]})}export{Je as default};
